# Q&A

## 引导流程

#### UEFI和BIOS的区别

提出时间：2023/8/21
解决时间：2023/8/21
Ans：
	UEFI本身就很强大? 甚至可以直接跑C的程序 UEFI兼容了BIOS的功能 所以暂时 当前阶段不再继续深入了解

#### UEFI的系统调用

提出时间：2023/8/21
解决时间：2023/8/21
Ans：
	UEFI 兼容 BIOS 的系统调用

#### 主分区 扩展分区 逻辑分区

提出时间：2023/8/21
解决时间：2023/8/21
Ans：

1. 硬盘结构：

   1. 磁道 柱面 扇区 在0柱面0盘面上的第一个扇区512字节 记录了整个硬盘的划分MBR
      1. 前446字节存放了Bootloader
      2. 之后的64字节分为4个16字节分别记录了各个分区的位置 就是磁盘分区表了 16个字节中存有活动状态标志、文件系统标识、起止柱面号、磁头号、扇区号、相对偏移扇区数量（4个字节）、分区总扇区数目（4个字节）
      3. 最后的两字节用于标记 MBR的有效标志，被称为Magic number，如果是55AA，则表示此MBR有效
2. 主分区：在MBR上 最多有三个主分区（BIOS下） 最少有一个主分区 主分区可以设置为活动分区
3. 扩展分区：抽象的分区 无法实际选择 扩展分区的16个字节 其中文件系统表示处为 0F 表示是扩展分区 其偏移地址指向的是下一个逻辑节点的地址
4. 逻辑分区：不限量 可以没有 使用得当可以降低文件簇的大小  可以保护对操作系统修改的时候保证文件的安全

   每一个逻辑分区中有512字节在头部前446字节无效 64字节的分区表只使用了前两项 第一项表示当前逻辑节点的信息 下一项指向了下一个逻辑节点 最为显著的 特点是文件系统标识 对于逻辑节点信息可能是07表示NTFS 而指向下一个逻辑节点的16字节 该位置上是05 二者偏移地址也不同 07的偏移地址指的是 从指向它的那个分区开始的偏移量 比如第一块逻辑分区的偏移地址假如是2048那是指相对于指向它的0F的那个512字节的首部开始计算的2048 此后的逻辑节点也是如此（二叉树的感觉 ）

   参考资料 ： [MBR主分区拓展分区逻辑分区介绍-第二课_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1NZ4y1H7gG/?spm_id_from=333.880.my_history.page.click)![img](https://gitee.com/TTaket/typora-image/raw/master/v2-2a8e5b453f2032bf5f641d0654e671fc_r.jpg)

#### UEFI如何识别U盘为启动盘

提出时间：2023/8/21
解决时间：2023/8/22
Ans：
	BIOS：系统自检装载过程就与我们的系统安装有关，BIOS只认识设备（硬盘），不认识分区，也不认识文件，因此他的作用仅仅是按照CMOS设置里面的顺序，挨个存储设备看，查看这个存储设备的前512字节是不是以0x55 0xAA结尾,不是，就跳过，是，就加载这里的前512字节的代码执行 注意这里查找的顺序，就是你在进入BIOS后设置的启动项顺序，这些设置保存在CMOS芯片中
	所以第一步首先设置 更高的优先级
	之后 在启动盘的 0 0 0 位置512字节位置设置一个55AA
	之后利用分区助手或者是手动操作 进行分区并且设定活动分区
	之后在活动分区首部的512字节进行操作系统的初始化

    UEFI： 暂时先不进行继续学习

#### BIOS 的完整引导流程

提出时间：2023/8/21
解决时间：2023/8/22
Ans：
	MBR会先检查硬盘分区表，然后根据硬盘分区表找到硬盘上的引导分区，将引导分区的首扇区（boot loader）内容调入内存，boot loader中的ntdlr（Windows引导程序）启动mini-file system divers以便能识别NEFS和FAT32的文件系统的硬盘分区。或者grub（Linux引导程序）启动vmlinuz-version和initrd-version.img（eg:Centos5.5中的/boot/vmlinuz-2.6.18-194.el5和/boot/initrd-2.6.18-194.el5.img）。便完成MBR的引导过程
	[硬盘格式与引导方式的区别 全面装系统教程进阶版 MBR与GPT UEFI 与LEGACY bios的区别与联系_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1bb411v7hp/?spm_id_from=333.788.recommend_more_video.0&vd_source=140617872e27fde02158a445f44419a0)

#### UEFI的完整引导流程

提出时间：2023/8/21
解决时间：2023/8/22
Ans：
	[(转)UEFI系统的启动过程_dxe init_gjq_1988的博客-CSDN博客](https://blog.csdn.net/gjq_1988/article/details/50593564)
	后续学习 暂时先完成任务 把U盘刷成 MBR分区 使用BIOS+MBR 进行引导

    [硬盘格式与引导方式的区别 全面装系统教程进阶版 MBR与GPT UEFI 与LEGACY bios的区别与联系_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1bb411v7hp/?spm_id_from=333.788.recommend_more_video.0&vd_source=140617872e27fde02158a445f44419a0)

#### 我的电脑如何实现的一个磁盘上双系统

提出时间：2023/8/21
解决时间：2023/8/22
Ans：

    如果是BIOS ： 通过主分区系统提供的引导程序，启动其余逻辑分区的系统
    我的电脑是UEFI 所以暂时不清楚

#### 我应该怎么安装我的操作系统到U盘上

提出时间：2023/8/22
解决时间：2023/8/22
Ans：
	dd 命令  linux万物皆文件 利用dd命令可以强制把一段机器码写到另一个文件的前512字节 这里 可以用dd 写入到我们的U盘 使得前512字节为我们想要的内容


#### 可移植性的讨论

问题发生在0.3 中的编写MBR分区表 过程中 考虑是否再MBR中指定操作系统的起始CHS 和结束CHS

提出时间：2023/8/22
解决时间：2023/8/22
Ans：

    应该写 MBR绑定在硬盘上 不影响操作系统的可移植性 而且MBR的数据本身就是通过另外一套操作系统修改的（刷盘） 之后再载入操作系统在该硬盘上 所以MBR 本身绑定在硬盘上 不会影响操作系统移植性 可以后续写fdisk工具 来协助改变MBR的内容 现阶段直接写死是没问题的

## 操作系统的实现

#### 我应该做什么？

提出时间：2023/8/22
解决时间：
Ans：

1. 首先 我不需要负责BIOS固件的硬件自检
2. 我应该提供什么？
   按照目前阶段需要提供汇编的库函数
   一个简单的shell 一些和文件系统有关的命令
   以后的话
   中断向量表 段页表。。
   硬件参数信息存放在固定位置 等等

#### 有助于操作系统编写的工具 - bochs

提出时间：2023/8/23
解决时间：2023/8/23
Ans：[Windows下Bochs的简单使用_bochs windows_的博客-CSDN博客](https://blog.csdn.net/lhl2014123/article/details/101867572)

#### 进入到保护模式后代码风格的改变 

提出时间：2023/8/28
解决时间：2023/8/28
Ans: 

​	不需要进行改变 仍然是 intel风格的就可以

#### 如何设计引入保护模式后的内存分布 以及多少层导入我们的kernel

提出时间：2023/8/28
解决时间：
Ans: 

#### 从保护模式回到实模式 可以直接关闭cr0吗 如果不可以为什么？

提出时间：2023/8/30
解决时间：
Ans: [从保护模式返回实模式_8086保护模式切换到实模式_](https://blog.csdn.net/LinuxArmbiggod/article/details/120856460)


#### 如何填装分区表GDT

提出时间：2023/8/28
解决时间：2023/8/28
Ans: 

​	网上的建议是写一个汇编实现的宏 更好的扩展以后的段 但是目前阶段为了更好地理解GDT表的内容 我们打算手写写死

#### 保护模式下仍然可以使用BIOS的系统调用吗

提出时间：2023/8/28
解决时间：
Ans: 

​	可以也不可以 如果想要使用的话 需要中断向量表IDT对应映射到BIOS的中断程序上面
​	或者临时跳转到实模式 等待中断响应结束后再跳回到保护模式



#### 需要提供中断向量表吗

提出时间：2023/8/28
解决时间：
Ans: 

#### 我需要负责硬件驱动的编写吗 ？ 或者至少编译进来？

提出时间：2023/8/22
解决时间：
Ans：

#### 我需要写一些临时的库函数吗?

提出时间：2023/8/22
解决时间：2023/8/27
Ans：需要 但是需要用汇编来写

#### 什么时候我可以用C语言来介入？

提出时间：2023/8/22
解决时间：2023/8/27
Ans：我们使用C语言 这里使用 `C`语言，并不是像平时那样，用 `C`语言各种库编程，而是使用 `C`语言的框架，也就是说 我们要用汇编实现一些基本函数 再利用C就可以调用这些基本函数 之所以使用C 是因为它的逻辑结构比汇编可读性要高很多！

## 汇编的编写

#### NASM 的使用？ 目的和方法？

提出时间：2023/8/21
解决时间：2023/8/21
Ans：

    作用：汇编的编译器

#### ORG 的作用

提出时间：2023/8/22
解决时间：2023/8/22
Ans：

    作用：[计算机自制操作系统（四）：汇编语言烧脑的ORG问题 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/100757410)

> 到此我们已经初步了解到了org指令的作用，一句话， **就是为程序中所有的内部地址引用增加一个段内偏移值**（引导程序可以看做是被加载到以0为基址的段，偏移为0x7c00）。

#### 不同种类汇编都有什么种类

提出时间：2023/8/22
解决时间：2023/8/22
Ans：
[维基百科的解释](https://zh.wikipedia.org/zh-hans/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80)
![image-20230822140149982](https://gitee.com/TTaket/typora-image/raw/master/image-20230822140149982.png)

#### 汇编跨文件调用函数

#### 文件系统相关内容 如何实现文件系统

提出时间：2023/8/21
解决时间：
Ans：

## 硬盘相关

#### 怎么从硬盘指定位置读数据 ?

提出时间：2023/8/21
解决时间：2023/8/23
Ans：

    我们采取的ban'fa办法是LBA方式 也就是利用端口进行输入读入![image-20230823122252945](https://gitee.com/TTaket/typora-image/raw/master/image-20230823122252945.png)

#### 硬盘的CHS 和LBA逻辑扇区号的映射逻辑 与 增加关系

提出时间：2023/8/24
解决时间：2023/8/24
Ans：
	CHS： C- 柱面(Cylinder) H-磁头(Heads) S-扇区(Sector)
	设NS为每磁道扇区数
		NH为磁头数
		C、H、S分别表示磁盘的柱面、磁头和扇区编号，LBA表示逻辑扇区号
			LBA=NH×NS×C+NS×H+S-1；
		也就是 先是扇区先移动 之后扇区移动一周后 磁头移动 磁头移动完整后 柱面最后移动

#### 硬盘的盘面数 磁道数  每条磁轨的扇区数量 怎么获得

提出时间：2023/8/24
解决时间：2023/8/24
Ans：
	分区助手：
	![image-20230824145856923](https://gitee.com/TTaket/typora-image/raw/master/image-20230824145856923.png)
	为什么 柱面数 * 每柱面的磁道数 * 每磁道的扇区数 小于 总扇区数量
		发现整除的情况下 数据恰好 疑似软件精度问题 不继续探索

#### 磁盘分区表中 逻辑起始扇区号作用？

提出时间：2023/8/24
解决时间：2023/8/28
Ans： 提供的是本512字节 相对于偏移过来的那个扇区的首部的距离 比如主分区相对的是0号扇区 比如扩展分区扩展出的节点相对的是扩展分区
